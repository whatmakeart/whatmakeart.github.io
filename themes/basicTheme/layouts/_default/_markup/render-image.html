<!-- Begin Include Markdown Files with ![Image](markdown.md) -->
{{- $includeUrl := urls.Parse .Destination -}}
{{- $r := "" }} <!-- initialize empty resource variable -->
<p>.Destination = {{.Destination }}</p>
<p>$includeUrl = {{ $includeUrl }}</p>
{{- if strings.HasSuffix $includeUrl.Path ".md" -}} <!-- Check if a markdown file extension -->

{{- with .Page.Resources.Get (strings.TrimPrefix "./" $includeUrl.Path) }}
{{- /* Destination is a page resource. */}}
<p>page resource</p>
{{- $r = . }}
{{- else }}
{{- with .Page.CurrentSection.Resources.Get (strings.TrimPrefix "./" $includeUrl.Path) }}
{{- /* Destination is a section resource. */}}
<p>section resource</p>
{{- $r = . }}

{{- else }}
{{- with resources.Get $includeUrl.Path }}
{{- /* Destination is a global resource. */}}
{{- $r = . }}
<p>$r</p>
{{- if os.FileExists $r -}} <!-- check if markdown file to include exists -->
<p>exists</p>
{{ .Destination | readFile | replaceRE "^---[\\s\\S]+?---" "" | markdownify }}
{{- else -}}
<p>does not exist</p>
{{- end -}}
{{- end -}} <!-- End Include Markdown Files with ![Image](markdown.md) -->
{{ end }}{{ end }}{{ end }}

{{- if not (strings.HasSuffix $includeUrl.Path ".md") -}} <!-- if not a .md file -->

<!-- Begin Example Code from Hugo Portable Links https://github.com/bep/portable-hugo-links -->
{{- $img := .Page.Resources.GetMatch .Destination -}}
{{- if and (not $img) .Page.File -}}
{{ $path := path.Join .Page.File.Dir .Destination }}
{{- $img = resources.Get $path -}}
{{- end -}}
{{- if and (not $img) .Page.File -}}
{{ $path := path.Join .Page.File.Dir .Destination }}
{{- $img = .Page.Resources.Get $path -}}
{{- end -}}
{{- if and (not $img) .Page.File -}}
{{ $path := path.Join .Page.File.Dir .Destination }}
{{- $img = .Page.CurrentSection.Resources.Get $path -}}
{{- end -}}
{{- with $img -}}
{{- $xlarge := $img.Resize "3840x" -}}
{{- $large := $img.Resize "2048x" -}}
{{- $medium := $img.Resize "1080x" -}}
{{- $small := $img.Resize "828x" -}}
{{- $xsmall := $img.Resize "640x" -}}

<figure class="image-caption">
  <img alt="{{ $.Text }}" srcset="
        {{ $xsmall.RelPermalink }} 640w, 
        {{ $small.RelPermalink }} 828w,
        {{ $medium.RelPermalink }} 1080w,
        {{ $large.RelPermalink }} 2840w,
        {{ $xlarge.RelPermalink }} 3840w" width="{{ $img.Width }}" sizes="50vw" src="{{ $xsmall.RelPermalink}}" />
  <figcaption>{{ with $.Title | safeHTML }}{{ . }}{{ end }}</figcaption>
</figure>
{{- else -}} <!-- End Example Code from Hugo Portable Links https://github.com/bep/portable-hugo-links -->

<!-- Begin check for images living in same folder as markdown-file.md for GitHub viewing -->
{{- $pageFolder := path.Dir .Page.RelPermalink }} <!-- Get the Relative URL of the Page -->
{{- $pageFolderUp := path.Dir $pageFolder -}} <!-- Remove the Hugo Created folder from URL-->
{{- $imgPath := path.Join $pageFolderUp .Destination -}}<!-- Join one folder up with the image .Destination -->

{{- if os.FileExists $imgPath -}} <!-- check if image is one directory up after Hugo Render -->

<img src="{{ $imgPath | safeURL }}" alt="{{ $.Text }}" /> <!-- Display image-->
{{- else -}} <!-- End check for images living in same folder as markdown-file.md for GitHub viewing -->

<!-- Display images that might have a full root path in their src -->
<img src="{{ .Destination | safeURL }}" alt="{{ $.Text }}" />{{- end -}}{{- end -}}{{- end -}}