{{ $currRellink := substr .RelPermalink 0 }}
{{ $currRellink := printf `"%s"` $currRellink }} <!-- adds quotes around outside to prevent finding common words as links like about -->
{{ $currContent := .Content }}
{{ $backlinks := slice }}
{{ $forwardlinks := slice }}

{{ $pages := .Site.RegularPages}}
{{ range $pages }}
{{ $currPagelink := substr .RelPermalink 0 }} <!-- Get link of page -->
{{ $found := findRE $currRellink .Content 1 }}
{{ $foundCourses := findRE `courses` $currPagelink }}<!-- Check if link of page has "courses "-->
{{ if and (not $foundCourses) $found}} <!-- only append if backlink doesn't come from courses -->
{{ $backlinks = $backlinks | append . }}
{{ else }}
{{ $rellink := substr .RelPermalink 0 }}
{{ $rellink := printf `"%s"` $rellink }} <!-- adds quotes around outside to prevent finding common links like about -->
{{ $found = findRE $rellink $currContent 1 }}
{{ if $found }}
{{ $forwardlinks = $forwardlinks | append . }}
{{ end }}
{{ end }}
{{ end }}

{{ $related := append $backlinks $forwardlinks }}

<!-- Modified from https://brainbaking.com/post/2022/04/true-backlink-support-in-hugo/ -->

<hr>
{{ if gt (len $backlinks) 0 }}
<div class="bl-section">
    <h4>Links to this note</h4>
    <div class="backlinks">
        <ul>
            {{ range $backlinks | first 10}}
            <li>
                <a href="{{ .RelPermalink }}">{{ .Title }}</a>
            </li>
            {{ end }}
        </ul>
    </div>
</div>
{{ else }}
<div class="bl-section">
    <h4>No notes link to this note</h4>
</div>

{{ end }}

<hr>
{{ if gt (len $forwardlinks) 0 }}
<div class="bl-section">
    <h4>This note links to</h4>
    <div class="backlinks">
        <ul>
            {{ range $forwardlinks | first 10}}
            <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
            {{ end }}
        </ul>
    </div>
</div>
{{ else }}
<div class="bl-section">
    <h4>This note does not link to other notes</h4>
</div>

{{ end }}