{{- /* Simple, safe link renderer:
  • Resolves internal links to content pages (keeps fragments).
  • Leaves static/asset links alone (path-cleaned).
  • Adds external-link icon for http(s) targets.
  • Does NOT write to any scratch (backlinks are built by backlinks.html). */
-}}

{{- $rawText := .Text | safeHTML -}}
{{- $hasAnchor := gt (len (findRE "<\\s*a\\b" $rawText 1)) 0 -}}

{{- $dest := .Destination -}}
{{- $isRemote := or (strings.HasPrefix $dest "http://")
  (strings.HasPrefix $dest "https://")
  (strings.HasPrefix $dest "mailto:")
  (strings.HasPrefix $dest "tel:")
-}}

{{- $resolved := $dest -}}

{{- if not $isRemote -}}
  {{- $u := urls.Parse $dest -}}
  {{- $fragment := "" -}}
  {{- with $u.Fragment }}{{- $fragment = printf "#%s" . -}}{{- end -}}
  {{- $p := $u.Path -}}

  {{- if and $p .Page.File -}}
    {{- if not (strings.HasPrefix $p "/") -}}
      {{- $p = path.Clean (path.Join .Page.File.Dir $p) -}}
    {{- else -}}
      {{- $p = strings.TrimPrefix "/" $p -}}
    {{- end -}}
  {{- end -}}

  {{- $base := strings.TrimSuffix ".md" $p -}}
  {{- $cands := slice
    $p
    (printf "%s.md" $base)
    (printf "%s/_index.md" (strings.TrimSuffix "/" $base))
  -}}

  {{- $t := false -}}
  {{- range $c := $cands -}}
    {{- if not $t -}}
      {{- with site.GetPage $c -}}{{- $t = . -}}{{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if $t -}}
    {{- $resolved = printf "%s%s" $t.RelPermalink $fragment -}}
  {{- else -}}
    {{- $clean := $dest -}}
    {{- if and (not (strings.HasPrefix $clean "/")) .Page.File -}}
      {{- $clean = path.Clean (printf "/%s" $p) -}}
    {{- else -}}
      {{- $clean = path.Clean $clean -}}
    {{- end -}}
    {{- $resolved = printf "%s%s" $clean $fragment -}}
  {{- end -}}
{{- end -}}

{{- if $hasAnchor -}}
  {{- $rawText -}}
{{- else -}}
  <a
    href="{{ $resolved | safeURL }}"
    {{ with .Title }}title="{{ . }}"{{ end }}{{ if $isRemote }}
      target="_blank" rel="noopener"
    {{ end }}
  >
    {{- $rawText -}}
    {{- if $isRemote -}}
      <span style="white-space:nowrap">
        &thinsp;
        <svg
          style="height:auto;width:0.6rem;margin-left:0.2rem;vertical-align:baseline"
          focusable="false"
          role="img"
          viewBox="0 0 792 792"
          xmlns="http://www.w3.org/2000/svg"
        >
          <title>external link</title>
          <path
            fill="none"
            stroke="currentColor"
            d="M678.08 396v315.12c0 31.4-25.43 56.85-56.79 56.85H81.49c-31.36 0-56.79-25.45-56.79-56.85V170.77c0-31.4 25.43-56.85 56.79-56.85h269.9"
            style="stroke-width:62;stroke-linecap:round;stroke-miterlimit:10"
          />
          <path
            stroke="currentColor"
            d="m165.25 626.76 489.74-489.75"
            style="stroke-width:54;stroke-linecap:round;stroke-miterlimit:10"
          />
          <path
            fill="currentColor"
            stroke="currentColor"
            d="M722.34 260.06 792 0 531.94 69.67z"
          />
        </svg>
      </span>
    {{- end -}}
  </a>
{{- end -}}
