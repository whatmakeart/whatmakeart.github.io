<!-- =========================================================================
     render-link.html
     -------------------------------------------------------------------------
     Goals
       • Resolve internal links to content pages (with fragments).
       • Record backlink/forwardlink graph on resolved content pages.
         ↳ EXCLUDE any link where either side’s .Section == "courses".
       • Don’t re-wrap if .Text already contains an <a> (e.g., [![..]](..)).

     Notes
       • Only Go template comments (no HTML comments) to avoid context issues.
   ========================================================================= -->

{{- getenv "HUGO_BUILD_ID" -}}
<!-- ADD THIS INVISIBLE CACHE-BUSTING LINE -->

{{- $rawText := .Text | safeHTML -}}
{{- $hasAnchor := gt (len (findRE "<\\s*a\\b" $rawText 1)) 0 -}}

{{- $dest := .Destination -}}
{{- $isRemote := or (strings.HasPrefix $dest "http://")
  (strings.HasPrefix $dest "https://")
  (strings.HasPrefix $dest "mailto:")
  (strings.HasPrefix $dest "tel:")
-}}

{{- $u := urls.Parse $dest -}}
{{- $fragment := "" -}}
{{- with $u.Fragment }}{{- $fragment = printf "#%s" . -}}{{- end -}}
{{- $p := $u.Path -}}

{{- $resolvedLink := $dest -}}
{{- $targetPage := .Page -}}
<!-- IMPORTANT: don’t use `nil` here -->
{{- $isContentTarget := false -}}

{{- if not $isRemote -}}
  <!-- Normalize candidate path relative to current page’s content dir -->
  {{- if and $p .Page.File -}}
    {{- if not (strings.HasPrefix $p "/") -}}
      {{- $p = path.Clean (path.Join .Page.File.Dir $p) -}}
    {{- else -}}
      {{- $p = strings.TrimPrefix "/" $p -}}
    {{- end -}}
  {{- end -}}


  <!-- Try to resolve to a real content page -->
  {{- $base := strings.TrimSuffix ".md" $p -}}
  {{- $cands := slice
    $p
    (printf "%s.md" $base)
    (printf "%s/_index.md" (strings.TrimSuffix "/" $base))
  -}}

  {{- $resolved := false -}}
  {{- range $c := $cands -}}
    {{- if not $resolved -}}
      {{- with $.Page.GetPage $c -}}
        {{- $targetPage = . -}}
        {{- $resolvedLink = printf "%s%s" .RelPermalink $fragment -}}
        {{- $isContentTarget = true -}}
        {{- $resolved = true -}}
      {{- end -}}
    {{- end -}}
    {{- if and (not $resolved) (ne $c $p) -}}
      {{- with $.Page.Site.GetPage $c -}}
        {{- $targetPage = . -}}
        {{- $resolvedLink = printf "%s%s" .RelPermalink $fragment -}}
        {{- $isContentTarget = true -}}
        {{- $resolved = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if not $resolved -}}
    <!-- Not a content page; static/asset path — just clean it. -->
    {{- $clean := $dest -}}
    {{- if and (not (strings.HasPrefix $clean "/")) .Page.File -}}
      {{- $clean = path.Clean (printf "/%s" $p) -}}
    {{- else -}}
      {{- $clean = path.Clean $clean -}}
    {{- end -}}
    {{- $resolvedLink = printf "%s%s" $clean $fragment -}}
  {{- end -}}
{{- end -}}


<!-- ================= Link Graph (exclude 'courses' edges) ================= -->
{{- $src := .Page -}}
{{- if and $isContentTarget $targetPage -}}

  {{- warnf "Processing Link: Src=%s Dest=%s" .Page.RelPermalink .Destination -}}

  {{/* <--- ADD THIS LINE */}}

  {{- $exclude := or (eq $src.Section "courses") (eq $targetPage.Section "courses") -}}

  {{- if not $exclude -}}
    <!-- Append unique to target.backlinks -->
    {{- $bk := $targetPage.Scratch.Get "backlinks" | default (slice) -}}
    {{- $already := false -}}
    {{- range $bk -}}
      {{- if eq .RelPermalink $src.RelPermalink -}}
        {{- $already = true -}}
      {{- end -}}
    {{- end -}}
    {{- if not $already -}}
      {{- $bk = $bk | append $src -}}
      {{- $targetPage.Scratch.Set "backlinks" $bk -}}
    {{- end -}}


    <!-- Append unique to src.forwardlinks -->
    {{- $fw := $src.Scratch.Get "forwardlinks" | default (slice) -}}
    {{- $tRel := $targetPage.RelPermalink -}}
    {{- $falready := false -}}
    {{- range $fw -}}
      {{- if eq .RelPermalink $tRel -}}{{- $falready = true -}}{{- end -}}
    {{- end -}}
    {{- if not $falready -}}
      {{- $fw = $fw | append $targetPage -}}
      {{- $src.Scratch.Set "forwardlinks" $fw -}}
    {{- end -}}
  {{- end -}}
{{- end -}}


<!-- ============================== OUTPUT ============================== -->
{{- if $hasAnchor -}}
  <!-- The text already includes an <a> (e.g. image link). Pass through. -->
  {{- $rawText -}}
{{- else -}}
  <a
    href="{{- $resolvedLink | safeURL -}}"
    {{ with .Title }}title="{{ . }}"{{ end }}
  >
    {{- $rawText -}}
    {{- if $isRemote -}}
      <span style="white-space:nowrap">
        &thinsp;
        <svg
          style="height:auto;width:0.6rem;margin-left:0.2rem;vertical-align:baseline"
          focusable="false"
          role="img"
          viewBox="0 0 792 792"
          xmlns="http://www.w3.org/2000/svg"
        >
          <title>external link</title>
          <path
            fill="none"
            stroke="currentColor"
            d="M678.08 396v315.12c0 31.4-25.43 56.85-56.79 56.85H81.49c-31.36 0-56.79-25.45-56.79-56.85V170.77c0-31.4 25.43-56.85 56.79-56.85h269.9"
            style="stroke-width:62;stroke-linecap:round;stroke-miterlimit:10"
          />
          <path
            stroke="currentColor"
            d="m165.25 626.76 489.74-489.75"
            style="stroke-width:54;stroke-linecap:round;stroke-miterlimit:10"
          />
          <path
            fill="currentColor"
            stroke="currentColor"
            d="M722.34 260.06 792 0 531.94 69.67z"
          />
        </svg>
      </span>
    {{- end -}}
  </a>
{{- end -}}
