<!-- =========================================================================
     render-image.html — fast Markdown includes + sibling-folder images
     ---------------------------------------------------------------------------
     • ![…](something.md)  → include Markdown (prefer content page, else raw file)
     • ![…](image.*)       → process via pipeline if possible; else:
                              - prefer /assets (resources.Get)
                              - else SIBLING-FOLDER fallback:
                                  try to serve from /static if a mirrored file exists
                                  else inline-embed with data: URL (base64)
     Notes:
       • No .Site.Pages scans; minimal os.FileExists.
       • All file-system checks use string paths (not URL objects).
     ========================================================================= -->

{{- $dest := .Destination -}}
{{- $isRemote := or (strings.HasPrefix $dest "http://") (strings.HasPrefix $dest "https://") -}}
{{- $u := urls.Parse $dest -}}
{{- $p := $u.Path -}}
{{/* plain string */}}


<!-- -------------------- 1) Markdown include via image syntax -------------------- -->
{{- if and (not $isRemote) (strings.HasSuffix $p ".md") -}}
  <!-- Normalize relative path against current page's content dir -->
  {{- if and $p .Page.File -}}
    {{- if not (strings.HasPrefix $p "/") -}}
      {{- $p = path.Clean (path.Join .Page.File.Dir $p) -}}
      {{/* content-relative */}}
    {{- else -}}
      {{- $p = strings.TrimPrefix "/" $p -}}
      {{/* content-root relative */}}
    {{- end -}}
  {{- end -}}


  <!-- Try as a content page first (fast, no disk I/O) -->
  {{- $base := strings.TrimSuffix ".md" $p -}}
  {{- $cands := slice
    $p
    (printf "%s.md" $base)
    (printf "%s/_index.md" (strings.TrimSuffix "/" $base))
  -}}
  {{- $included := false -}}
  {{- range $c := $cands -}}
    {{- if not $included -}}
      {{- with $.Site.GetPage $c -}}
        <div data-pagefind-ignore>{{ .Content }}</div>
        {{- $included = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if not $included -}}
    <!-- Fallback: read raw file from /content and render here -->
    {{- $probe := path.Clean (path.Join "content" $p) -}}
    {{- if not (os.FileExists $probe) -}}
      {{- $probe = path.Clean (path.Join "content" (strings.TrimPrefix "/" $p)) -}}
    {{- end -}}
    {{- if os.FileExists $probe -}}
      <div data-pagefind-ignore>
        {{- $raw := readFile $probe -}}
        {{- $nofm := replaceRE "^---[\\s\\S]+?---\\s*" "" $raw -}}
        {{- .Page.RenderString $nofm -}}
      </div>
    {{- else -}}
      <!-- include not found: {{ $p }} -->
    {{- end -}}
  {{- end -}}


  <!-- -------------------- 2) Regular images (optimize if possible) -------------------- -->
{{- else -}}
  <!-- Try page-bundle resource (fast + cached) -->
  {{- $img := .Page.Resources.GetMatch $dest -}}
  {{- if not $img -}}
    <!-- also try by basename in case author wrote ../img.png -->
    {{- $img = .Page.Resources.GetMatch (path.Base $p) -}}
  {{- end -}}


  <!-- Try /assets (pipeline-capable) -->
  {{- if not $img -}}
    {{- $assetsCand := strings.TrimPrefix "/" $p -}}
    {{- $assetsCand = strings.TrimPrefix "assets/" $assetsCand -}}
    {{- $img = resources.Get $assetsCand -}}
  {{- end -}}

  {{- if $img -}}
    <!-- Pipeline chain — adjust to your taste -->
    {{- $large  := $img.Resize "1200x" -}}
    {{- $medium := $large.Fill  "726x402 smart" -}}
    {{- $small  := $medium.Fill "458x254 smart" -}}
    <figure class="image-caption">
      <img
        alt="{{ $.Text }}"
        srcset="
          {{ $small.RelPermalink }}  458w,
          {{ $medium.RelPermalink }}  726w,
          {{ $large.RelPermalink }} 1200w
        "
        sizes="50vw"
        src="{{ $small.RelPermalink }}"
        class="img-fluid"
      />
      <figcaption>{{ with $.Title | safeHTML }}{{ . }}{{ end }}</figcaption>
    </figure>
  {{- else -}}
    <!-- ---------------- SIBLING-FOLDER FALLBACKS ---------------- -->

    <!-- 2.a: Compute the path of a sibling image next to the MD file in /content -->
    {{- $sibDisk := "" -}}
    {{- if and .Page.File $p -}}
      {{- $joined := "" -}}
      {{- if not (strings.HasPrefix $p "/") -}}
        {{- $joined = path.Clean (path.Join .Page.File.Dir $p) -}}
      {{- else -}}
        {{- $joined = strings.TrimPrefix "/" $p -}}
      {{- end -}}
      {{- $probeContent := path.Clean (path.Join "content" $joined) -}}
      {{- if os.FileExists $probeContent -}}
        {{- $sibDisk = $probeContent -}}
      {{- end -}}
    {{- end -}}

    {{- if $sibDisk -}}
      <!-- 2.b: If a mirrored copy exists in /static, serve that public URL -->
      {{- $relFromContent := strings.TrimPrefix "content/" $sibDisk -}}
      {{- $staticDisk := path.Clean (path.Join "static" $relFromContent) -}}
      {{- if os.FileExists $staticDisk -}}
        {{- $publicURL := printf "/%s" (strings.TrimPrefix "/" $relFromContent) -}}
        <img
          class="img-fluid"
          src="{{ $publicURL | safeURL }}"
          alt="{{ $.Text }}"
        />
      {{- else -}}
        <!-- 2.c: Inline embed as data: URL so the site still shows the sibling image.
                 Keeps your repo layout (GitHub works), and site works without moving files.
                 NOTE: Big images will bloat HTML; move to page bundle/assets when possible. -->
        {{- $raw := readFile $sibDisk -}}
        {{- $b64 := base64Encode $raw -}}
        {{- $ext := lower (path.Ext $sibDisk) -}}
        {{- $mime := cond (eq $ext ".png") "image/png"
          (cond (or (eq $ext ".jpg") (eq $ext ".jpeg")) "image/jpeg"
          (cond (eq $ext ".webp") "image/webp"
          (cond (eq $ext ".gif") "image/gif"
          (cond (eq $ext ".svg") "image/svg+xml" "application/octet-stream"))))
        -}}
        <img
          class="img-fluid"
          src="data:{{ $mime }};base64,{{ $b64 }}"
          alt="{{ $.Text }}"
        />
      {{- end -}}

    {{- else -}}
      <!-- 2.d: Last-resort plain URL (works for absolute/remote and already-public paths) -->
      {{- $src := $dest -}}
      {{- if and (not $isRemote) (not (strings.HasPrefix $src "/")) -}}
        {{- $src = printf "/%s" (strings.TrimPrefix "/" $src) -}}
      {{- end -}}
      <img class="img-fluid" src="{{ $src | safeURL }}" alt="{{ $.Text }}" />
    {{- end -}}
  {{- end -}}
{{- end -}}
