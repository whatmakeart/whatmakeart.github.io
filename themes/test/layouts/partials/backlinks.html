{{- /* Backlinks/forwardlinks by scanning rendered HTML.
      Excludes any edge where either page is in the "courses" section. */ -}}

{{- /* If THIS page is in courses, show nothing at all. */ -}}
{{- if ne .Section "courses" -}}

  {{- $curr := . -}}
  {{- $currContent := .Content -}}
  {{- $currNoSlash := strings.TrimSuffix "/" .RelPermalink -}}

  {{- /* Pattern that finds href="/path", href="/path/", and href="/path#..." */ -}}
  {{- $patForMe := printf `href="%s(/|#|")` $currNoSlash -}}

  {{- $backlinks := slice -}}
  {{- $forward := slice -}}

  {{- /* Only consider regular pages not in courses */ -}}
  {{- $pages := where site.RegularPages "Section" "ne" "courses" -}}

  {{- range $p := $pages -}}
    {{- if ne $p.RelPermalink $curr.RelPermalink -}}

      {{- /* Does $p link to current page? */ -}}
      {{- $m := findRE $patForMe $p.Content 1 -}}
      {{- if gt (len $m) 0 -}}
        {{- $backlinks = $backlinks | append $p -}}
      {{- end -}}

      {{- /* Does current page link to $p ? */ -}}
      {{- $pNoSlash := strings.TrimSuffix "/" $p.RelPermalink -}}
      {{- $patP := printf `href="%s(/|#|")` $pNoSlash -}}
      {{- $m2 := findRE $patP $currContent 1 -}}
      {{- if gt (len $m2) 0 -}}
        {{- $forward = $forward | append $p -}}
      {{- end -}}

    {{- end -}}
  {{- end -}}

  {{- /* De-dup both slices */ -}}
  {{- $seenBk := dict -}}
  {{- $bk := slice -}}
  {{- range $backlinks -}}
    {{- $k := .RelPermalink -}}
    {{- if not (isset $seenBk $k) -}}
      {{- $seenBk = merge $seenBk (dict $k true) -}}
      {{- $bk = $bk | append . -}}
    {{- end -}}
  {{- end -}}

  {{- $seenFw := dict -}}
  {{- $fw := slice -}}
  {{- range $forward -}}
    {{- $k := .RelPermalink -}}
    {{- if not (isset $seenFw $k) -}}
      {{- $seenFw = merge $seenFw (dict $k true) -}}
      {{- $fw = $fw | append . -}}
    {{- end -}}
  {{- end -}}

  <div id="backlinks-container">
    <hr />
    {{ if gt (len $bk) 0 }}
      <div class="bl-section">
        <h4>Links to this note</h4>
        <div class="backlinks">
          <ul>
            {{ range $bk | first 10 }}
              <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
            {{ end }}
          </ul>
        </div>
      </div>
    {{ else }}
      <div class="bl-section">
        <h4 class="small text-muted font-weight-light">No notes link to this note</h4>
      </div>
    {{ end }}

    <hr />
    {{ if gt (len $fw) 0 }}
      <div class="bl-section">
        <h4>This note links to</h4>
        <div class="backlinks">
          <ul>
            {{ range $fw | first 10 }}
              <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
            {{ end }}
          </ul>
        </div>
      </div>
    {{ else }}
      <div class="bl-section">
        <h4 class="small text-muted font-weight-light">This note does not link to other notes</h4>
      </div>
    {{ end }}
  </div>

{{- end -}}  {{/* end: not courses */}}
