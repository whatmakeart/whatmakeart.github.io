{{- /* Backlinks/forwardlinks by scanning rendered HTML.
  Excludes any edge where either page is in the "courses" section. */
-}}

{{- /* If THIS page is in courses, show nothing at all. */ -}}
{{- if ne .Section "courses" -}}

  {{- $curr := . -}}

  {{- /* Initialize slices and dictionaries for tracking */ -}}
  {{- $backlinks := slice -}}
  {{- $forwardlinks := slice -}}
  {{- $seenBacklink := dict -}}
  {{- $seenForwardlink := dict -}}

  {{- /* =================== FIND BACKLINKS =================== */ -}}
  {{- $pages := where site.RegularPages "Section" "ne" "courses" -}}
  {{- $patForMe := printf `href="%s(/|#|")` (strings.TrimSuffix "/" .RelPermalink) -}}

  {{- range $p := $pages -}}
    {{- if ne $p.RelPermalink $curr.RelPermalink -}}
      {{- if not (isset $seenBacklink $p.RelPermalink) -}}
        {{- with findRE $patForMe $p.Content 1 -}}
          {{- $backlinks = $backlinks | append $p -}}
          {{- $seenBacklink = merge $seenBacklink (dict $p.RelPermalink true) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- /* =================== FIND FORWARD LINKS (FINAL, COMPATIBLE METHOD) =================== */ -}}
  {{- /* 1. Use a simple, compatible regex to find ALL href attributes. */ -}}
  {{- $linkPattern := `href="[^"]+"` -}}
  {{- $foundLinks := findRE $linkPattern .Content -}}

  {{- range $foundLinks -}}
    {{- /* Trim 'href="' and '"' from the result to get the clean URL */ -}}
    {{- $link := . | strings.TrimPrefix `href="` | strings.TrimSuffix `"` -}}

    {{- /* 2. Manually check for and exclude external links and fragments before processing. */ -}}
    {{- if and $link (not (strings.HasPrefix $link "http")) (not (strings.HasPrefix $link "mailto")) (not (strings.HasPrefix $link "tel")) (not (strings.HasPrefix $link "#")) -}}

      {{- /* Clean the link by removing any URL fragment (e.g., #heading) */ -}}
      {{- $link = index (strings.Split $link "#") 0 -}}

      {{- with $curr.GetPage $link -}}
        {{- if and (ne .Section "courses") (ne .RelPermalink $curr.RelPermalink) (not (isset $seenForwardlink .RelPermalink)) -}}
          {{- $forwardlinks = $forwardlinks | append . -}}
          {{- $seenForwardlink = merge $seenForwardlink (dict .RelPermalink true) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}


  <div id="backlinks-container">
    <hr />
    {{ if $backlinks }}
      <div class="bl-section">
        <h4>Links to this note</h4>
        <div class="backlinks">
          <ul>
            {{ range $backlinks | first 10 }}
              <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
            {{ end }}
          </ul>
        </div>
      </div>
    {{ else }}
      <div class="bl-section">
        <h4 class="small text-muted font-weight-light">
          No notes link to this note
        </h4>
      </div>
    {{ end }}


    <hr />
    {{ if $forwardlinks }}
      <div class="bl-section">
        <h4>This note links to</h4>
        <div class="backlinks">
          <ul>
            {{ range $forwardlinks | first 10 }}
              <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
            {{ end }}
          </ul>
        </div>
      </div>
    {{ else }}
      <div class="bl-section">
        <h4 class="small text-muted font-weight-light">
          This note does not link to other notes
        </h4>
      </div>
    {{ end }}
  </div>
{{- end -}}
